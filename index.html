<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracc Pod Display</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    .slide {
      display: none;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .active { display: flex; }

    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1;
    }

    .content {
      position: relative;
      z-index: 2;
    }

    .logo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 140px;
      opacity: 0.8;
      z-index: 3;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 0.2em;
    }

    p {
      font-size: 1.3em;
      margin: 0.4em 0;
    }

    /* Calendar + Timeline layout */
    .calendar-container {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: center;
      gap: 60px;
      width: 90%;
      margin-top: 2em;
    }

    .calendar {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
    }

    .calendar table {
      border-collapse: collapse;
      width: 320px;
    }

    .calendar th {
      padding: 8px;
      color: #ccc;
      font-weight: normal;
    }

    .calendar td {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .calendar td.booked { background: rgba(0,255,0,0.4); }
    .calendar td.today { border: 1px solid #fff; }

    /* Timeline styling */
    .timeline {
      width: 340px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
    }

    .time-slot {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }

    .time-label {
      width: 60px;
      text-align: right;
      margin-right: 8px;
      color: #ccc;
      font-size: 0.9em;
    }

    .time-bar {
      flex: 1;
      height: 14px;
      background: rgba(255,255,255,0.15);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .time-fill {
      background: limegreen;
      position: absolute;
      height: 100%;
      top: 0;
      left: 0;
    }

    footer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      color: #999;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <img class="logo" src="assets/TraccLogo1.png" alt="Tracc Civil Logo" />

  <!-- Slide 1: Random Image -->
  <div id="slide1" class="slide active">
    <div class="overlay"></div>
    <div class="content">
      <h1 id="podName">Pod Display</h1>
    </div>
  </div>

  <!-- Slide 2: Upcoming Booking -->
  <div id="slide2" class="slide">
    <div class="overlay"></div>
    <div class="content">
      <h1>Up Next</h1>
      <p id="upNext"></p>
    </div>
  </div>

  <!-- Slide 3: Calendar + Timeline -->
  <div id="slide3" class="slide">
    <div class="overlay"></div>
    <div class="content">
      <h1>Monthly View</h1>
      <div class="calendar-container">
        <div class="calendar" id="calendar"></div>
        <div class="timeline" id="timeline"></div>
      </div>
    </div>
  </div>

  <footer>Tracc Civil Â© 2025</footer>

  <script>
    const podName = window.location.hostname.includes("ferns") ? "Ferns Pool"
                    : window.location.hostname.includes("rock") ? "Elephant Rocks"
                    : "Lucky Bay";
    document.getElementById("podName").textContent = podName;

    const logicAppUrl = window.location.hostname.includes("ferns") ?
      "https://prod-24.australiaeast.logic.azure.com:443/workflows/892f1a4dde764f609db25d146d30241d/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=KZmLYv6oUmBry5KzqE5Rftqw0mENlHO2bdksGfNhGpI" :
      window.location.hostname.includes("rock") ?
      "https://prod-13.australiaeast.logic.azure.com:443/workflows/a6a094d7071142628d6fe9ae820abeb0/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=nrO4sSvqce9x1zUoEDUUWeVFjAbLozbt6WPhZA17FuY" :
      "https://prod-29.australiaeast.logic.azure.com:443/workflows/6921a86944c74a179f6551abb63ae762/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=8CGTf5ohe-BvaGJ436YqtT44nC4d-iw00A8t1mh-5N8";

    // --- Slide control ---
    const slides = document.querySelectorAll(".slide");
    let current = 0;
    const rotateSlides = () => {
      slides[current].classList.remove("active");
      current = (current + 1) % slides.length;
      slides[current].classList.add("active");
    };
    setInterval(rotateSlides, 10000); // 10s per slide

    // --- Load Images ---
    const podFolder = podName.replace(" ", "");
    const totalImages = 3;
    const imgNum = Math.floor(Math.random() * totalImages) + 1;
    const bgUrl = `Pod-Images/${podFolder}/${imgNum}.jpg`;
    slides.forEach(s => s.style.backgroundImage = `url('${bgUrl}')`);

    // --- Fetch Data ---
    fetch(logicAppUrl, { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (!data.length) return;

        // Up next
        const next = data[0];
        const options = { timeZone: "Australia/Perth", hour: '2-digit', minute: '2-digit' };
        const start = new Date(next.start);
        const end = new Date(next.end);
        document.getElementById("upNext").innerHTML =
          `<strong>${next.subject}</strong><br>${next.organizer}<br>${start.toLocaleString('en-AU', options)} - ${end.toLocaleString('en-AU', options)}<br>${next.location}`;

        renderCalendar(data);
      });

    // --- Render Calendar + Timeline ---
    function renderCalendar(events) {
      const calDiv = document.getElementById("calendar");
      const tlDiv = document.getElementById("timeline");
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const bookedDays = {};
      events.forEach(ev => {
        const d = new Date(ev.start);
        if (!bookedDays[d.getDate()]) bookedDays[d.getDate()] = [];
        bookedDays[d.getDate()].push(ev);
      });

      // Build calendar
      let html = "<table><tr>";
      const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      days.forEach(d => html += `<th>${d}</th>`);
      html += "</tr><tr>";
      for (let i = 0; i < firstDay; i++) html += "<td></td>";
      for (let d = 1; d <= daysInMonth; d++) {
        const classes = [];
        if (bookedDays[d]) classes.push("booked");
        if (d === now.getDate()) classes.push("today");
        html += `<td class="${classes.join(" ")}" data-day="${d}">${d}</td>`;
        if ((d + firstDay) % 7 === 0) html += "</tr><tr>";
      }
      html += "</tr></table>";
      calDiv.innerHTML = html;

      const allCells = calDiv.querySelectorAll("td[data-day]");
      allCells.forEach(td => td.addEventListener("click", e => {
        const day = +e.target.dataset.day;
        renderTimeline(bookedDays[day] || []);
      }));

      renderTimeline(bookedDays[now.getDate()] || []);
    }

    function renderTimeline(dayEvents) {
      const tlDiv = document.getElementById("timeline");
      const startHour = 8, endHour = 17;
      let html = "";

      for (let h = startHour; h <= endHour; h++) {
        const label = `${h.toString().padStart(2,"0")}:00`;
        const slotEvents = dayEvents.filter(ev => {
          const s = new Date(ev.start).getHours();
          const e = new Date(ev.end).getHours();
          return h >= s && h < e;
        });
        const fillPercent = slotEvents.length ? 100 : 0;
        html += `
          <div class="time-slot">
            <div class="time-label">${label}</div>
            <div class="time-bar"><div class="time-fill" style="width:${fillPercent}%;"></div></div>
          </div>`;
      }
      tlDiv.innerHTML = html;
    }
  </script>
</body>
</html>
