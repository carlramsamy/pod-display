<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pod Display</title>

<style>
  :root{
    --bg:#fff;
    --ink:#222;
    --muted:#6b7280;
    --busy:#2e7d32;
    --accent:#0b5fff;
    --shadow:0 8px 28px rgba(16,24,40,.12);
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden;color:var(--ink)}
  .frame{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#fff}
  /* Slides */
  .slide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity .6s ease,visibility .6s ease}
  .slide.active{opacity:1;visibility:visible}
  /* Common inner plate (white margin all around) */
  .plate{position:relative;width:96vw;height:96vh;background:#fff;border-radius:26px;box-shadow:var(--shadow);padding:28px;box-sizing:border-box;display:flex;align-items:center;justify-content:center}
  /* Fixed logo (never overlaps image) */
  .logoFixed{position:absolute;top:22px;right:26px;z-index:5}
  .logoFixed img{height:60px;width:auto;display:block}
  /* Footer */
  .footer{position:absolute;bottom:10px;left:0;right:0;text-align:center;color:#8e99a6;font-size:14px}
  /* Hero photos */
  .heroWrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
  .hero{max-width:92%;max-height:80vh;border-radius:14px;object-fit:contain;display:block}
  .heroTitle{position:absolute;top:50%;transform:translateY(-50%);width:100%;text-align:center;font-weight:900;font-size:54px;color:#fff;text-shadow:2px 2px 10px rgba(0,0,0,.75)}
  /* Next booking card */
  .card{background:#fff;border-radius:22px;padding:42px 56px;box-shadow:var(--shadow);text-align:center;max-width:760px}
  .card h1{margin:0 0 12px;font-size:46px;font-weight:900}
  .card h2{margin:6px 0 8px;font-size:30px;font-weight:800}
  .meta{color:var(--muted);font-size:18px}
  .when{margin:12px 0 6px;font-size:24px;font-weight:800}
  .where{font-size:20px}
  .pill{display:inline-block;margin-top:14px;background:var(--busy);color:#fff;border-radius:999px;padding:6px 14px;font-weight:800;font-size:14px}
  .pill.gray{background:#6b7280}
  /* Calendar */
  .calWrap{width:100%;height:100%;display:flex;flex-direction:column}
  .calHead{display:flex;align-items:center;justify-content:space-between;margin:2px 0 10px}
  .calHead h1{margin:0;font-size:40px;font-weight:900}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:minmax(86px,1fr);gap:10px;width:100%;flex:1}
  .day{background:#f7f7f7;border-radius:12px;position:relative;padding:6px 8px;overflow:hidden}
  .day .num{position:absolute;top:6px;right:10px;font-size:11px;font-weight:800;color:#9ca3af}
  .day.today{outline:3px solid var(--accent);outline-offset:-3px}
  .tag{display:inline-block;background:var(--busy);color:#fff;border-radius:999px;padding:4px 7px;font-size:11px;font-weight:800;margin-top:18px;white-space:nowrap}
  /* Fade between slides */
  .fade {animation: fade .6s ease both}
  @keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
  <div class="frame">

    <!-- Slide 1: Hero 01 -->
    <section class="slide active" id="s1">
      <div class="plate fade">
        <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
        <div class="heroWrap">
          <img id="hero1" class="hero" alt="Pod image 1">
          <div id="hero1Title" class="heroTitle"></div>
        </div>
      </div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </section>

    <!-- Slide 2: Next booking (today only, with in-progress) -->
    <section class="slide" id="s2">
      <div class="plate fade" style="display:flex;align-items:center;justify-content:center">
        <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
        <div class="card">
          <h1>Next Booking</h1>
          <h2 id="nbWho">Loading…</h2>
          <div class="meta" id="nbOrg"></div>
          <div class="when" id="nbWhen"></div>
          <div class="where" id="nbWhere"></div>
          <div class="pill" id="nbStatus">Busy</div>
        </div>
      </div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </section>

    <!-- Slide 3: Hero 02 -->
    <section class="slide" id="s3">
      <div class="plate fade">
        <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
        <div class="heroWrap">
          <img id="hero2" class="hero" alt="Pod image 2">
          <div id="hero2Title" class="heroTitle"></div>
        </div>
      </div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </section>

    <!-- Slide 4: Month calendar (shows bookings) -->
    <section class="slide" id="s4">
      <div class="plate fade">
        <div class="calWrap">
          <div class="calHead">
            <h1 id="monthLabel">Month YYYY</h1>
            <div class="logoFixed" style="position:static"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
          </div>
          <div id="calendar" class="calendar"></div>
        </div>
      </div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </section>

    <!-- Slide 5: Hero 03 -->
    <section class="slide" id="s5">
      <div class="plate fade">
        <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
        <div class="heroWrap">
          <img id="hero3" class="hero" alt="Pod image 3">
          <div id="hero3Title" class="heroTitle"></div>
        </div>
      </div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </section>

  </div>

<script>
/* ------------------- UTILITIES ------------------- */
const TZ = "Australia/Perth";           // Force Perth logic
const qs = (id)=>document.getElementById(id);
const fmtMonth = (d)=> new Intl.DateTimeFormat('en-AU',{timeZone:TZ,month:'long',year:'numeric'}).format(d);
const fmtHM    = (d)=> new Intl.DateTimeFormat('en-AU',{timeZone:TZ,hour:'2-digit',minute:'2-digit',hour12:false}).format(d);

/* Parse flow format "dd/MM/yyyy HH:mm" as **UTC**, then Date will format to Perth correctly */
function parseFlowUtc(str){
  // guard
  if(!str || typeof str !== 'string') return new Date(NaN);
  const [d,m,rest] = str.split('/');
  const [y, hm] = rest.split(' ');
  const [H, M] = hm.split(':');
  const utc = Date.UTC(+y, (+m)-1, +d, +H, +M);
  return new Date(utc);
}

/* Get y-m-d in TZ for date comparisons */
function ymdInTZ(date, tz=TZ){
  const p = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  const obj = Object.fromEntries(p.map(x=>[x.type,x.value]));
  return `${obj.year}-${obj.month}-${obj.day}`;
}
function sameDayTZ(a,b){ return ymdInTZ(a) === ymdInTZ(b); }

/* ------------------- CONFIG / INPUTS ------------------- */
const params = new URLSearchParams(location.search);
const podKey = (params.get("pod")||"").replace(/\s+/g,""); // e.g. FernsPool
const SETTINGS_URL = "config/settings.json";

let podCfg=null;
let events=[];

/* ------------------- SLIDESHOW ------------------- */
const SLIDES = [
  { id:"s1", dur:10000 },
  { id:"s2", dur:15000 },
  { id:"s3", dur:15000 },
  { id:"s4", dur:15000 },
  { id:"s5", dur:15000 },
];
let si=0, timer=null;
function showSlide(i){
  document.querySelectorAll(".slide").forEach(s=>s.classList.remove("active"));
  qs(SLIDES[i].id).classList.add("active");
  clearTimeout(timer);
  timer = setTimeout(()=>{ si=(i+1)%SLIDES.length; showSlide(si); }, SLIDES[i].dur);
}

/* ------------------- RENDER ------------------- */
function renderHeroes(){
  const name = podCfg.displayName || podKey;
  qs("hero1Title").textContent = name;
  qs("hero2Title").textContent = name;
  qs("hero3Title").textContent = name;
  qs("hero1").src = `Pod-Images/${podKey}/01.jpg`;
  qs("hero2").src = `Pod-Images/${podKey}/02.jpg`;
  qs("hero3").src = `Pod-Images/${podKey}/03.jpg`;
}

/* Next booking: **today only**, show "In progress" if now in range; else next upcoming; else "No bookings today" */
function renderNextBooking(){
  const now = new Date();                       // system time
  const nowPerth = new Date(now.toLocaleString('en-US',{timeZone:TZ}));

  const todays = events
    .filter(e => sameDayTZ(e.start, nowPerth))
    .sort((a,b)=>a.start-b.start);

  const who = qs("nbWho"), org=qs("nbOrg"), when=qs("nbWhen"), where=qs("nbWhere"), st=qs("nbStatus");

  if (todays.length === 0){
    who.textContent = "No bookings currently booked for today";
    org.textContent = ""; when.textContent=""; where.textContent=""; st.textContent=""; st.className="pill gray";
    return;
  }

  // pick "in progress" if any, otherwise the next event today after now
  let current = todays.find(e => e.start <= nowPerth && nowPerth < e.end);
  let next    = todays.find(e => e.start > nowPerth);
  const ev = current || next || todays[todays.length-1]; // last one if day is almost done

  who.textContent  = ev.title || "Booked";
  org.textContent  = ev.organizer ? `Organizer: ${ev.organizer}` : "";
  when.textContent = `${fmtMonth(ev.start)} — ${fmtHM(ev.start)}–${fmtHM(ev.end)}`;
  where.textContent= ev.location ? `Location: ${ev.location}` : "";
  if (current){
    st.textContent="In progress";
    st.className="pill";
  } else {
    st.textContent="Busy";
    st.className="pill";
  }
}

/* Calendar: paint month + bookings (chips) */
function renderCalendar(){
  const cal = qs("calendar");
  cal.innerHTML = "";
  const now = new Date();
  const per = new Date(now.toLocaleString('en-US',{timeZone:TZ}));
  qs("monthLabel").textContent = fmtMonth(per);

  const y = per.getFullYear();
  const m = per.getMonth();
  const first = new Date(y, m, 1);
  const firstWD = first.getDay();
  const days = new Date(y, m+1, 0).getDate();

  // blanks
  for (let i=0;i<firstWD;i++){
    const d = document.createElement('div'); d.className="day"; d.style.visibility="hidden"; cal.appendChild(d);
  }
  for (let d=1; d<=days; d++){
    const cell = document.createElement('div'); cell.className="day";
    const num = document.createElement('div'); num.className="num"; num.textContent=d; cell.appendChild(num);

    const cellDate = new Date(y, m, d);
    if (sameDayTZ(cellDate, per)) cell.classList.add("today");

    // add tags for events on this date (in Perth terms)
    events.forEach(ev=>{
      if (ev.start.getFullYear()===y){
        const sd = new Date(ev.start.toLocaleString('en-US',{timeZone:TZ}));
        if (sd.getFullYear()===y && sd.getMonth()===m && sd.getDate()===d){
          const tag = document.createElement('div');
          tag.className="tag";
          tag.textContent = `${fmtHM(ev.start)} – ${fmtHM(ev.end)} · Busy`;
          cell.appendChild(tag);
        }
      }
    });

    cal.appendChild(cell);
  }
}

/* ------------------- BOOT ------------------- */
async function boot(){
  // settings + endpoint
  const cfg = await fetch(SETTINGS_URL,{cache:"no-store"}).then(r=>r.json());
  podCfg = cfg.pods[podKey];
  renderHeroes();

  // events
  const raw = await fetch(podCfg.endpoint,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:"{}",
    cache:"no-store"
  }).then(r=>r.json());

  // normalise events to AWST using the flow’s UTC-like strings
  events = (raw||[]).map(e=>{
    const s = parseFlowUtc(e.start);
    const en = parseFlowUtc(e.end);
    return {
      title: e.subject||"",
      organizer: e.organizer||"",
      location: e.location||"",
      start: s,  // keep as Date; we always format in TZ
      end: en
    };
  }).sort((a,b)=>a.start-b.start);

  renderNextBooking();
  renderCalendar();
  showSlide(0);
}

boot().catch(console.error);
</script>
</body>
</html>
