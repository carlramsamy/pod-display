<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="color-scheme" content="light only" />
  <title>Pod Display</title>
  <style>
    :root{
      --brand:#0a2540;
      --ink:#111;
      --muted:#666;
      --card:#fff;
      --bg:#fff;
      --accent:#0b5fff;
      --busy:#2e7d32;
      --shadow:0 8px 28px rgba(16,24,40,0.08), 0 2px 8px rgba(16,24,40,0.06);
      --radius:16px;
      --maxw:1280px;
    }
    html,body{
      margin:0; padding:0; height:100%;
      background:var(--bg) !important; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{
      min-height:100vh; display:flex; flex-direction:column; align-items:center;
    }
    /* Header */
    .bar{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      box-sizing:border-box;
      padding:14px 22px;
      max-width:var(--maxw);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      background:rgba(255,255,255,.95);
      padding:6px 12px; border-radius:12px;
      box-shadow:var(--shadow);
    }
    .brand img{ height:28px; width:auto; display:block; }
    .brand .title{
      font-size:24px; font-weight:800; letter-spacing:.3px; color:var(--brand);
    }

    /* Slides container */
    .stage{
      width:100%;
      max-width:var(--maxw);
      padding:0 22px 18px;
      box-sizing:border-box;
      display:grid;
    }
    .slide{
      display:none;
      width:100%;
      background:var(--bg) !important;
    }
    .slide.active{ display:block; }

    /* Image slides */
    .hero{
      position:relative;
      width:100%;
      height:calc(100vh - 120px);
      max-height:880px;     /* keeps inside most TVs */
      border-radius:24px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:#fff;
    }
    .hero img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .hero .heroTitle{
      position:absolute; inset:0 0 auto 0; top:18px;
      width:100%; text-align:center;
      font-size:48px; font-weight:800; color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.35), 0 6px 24px rgba(0,0,0,.55);
      letter-spacing:.4px;
      pointer-events:none;
    }

    /* Next booking card */
    .cardWrap{
      display:flex; align-items:center; justify-content:center;
      height:calc(100vh - 120px);
    }
    .card{
      width:min(880px, 92vw);
      background:var(--card);
      border-radius:24px; box-shadow:var(--shadow);
      padding:32px 36px; text-align:center;
    }
    .h1{ font-size:42px; font-weight:900; margin:0 0 10px; letter-spacing:.3px; }
    .h2{ font-size:26px; font-weight:800; margin:12px 0 4px; }
    .meta{ color:var(--muted); font-size:18px; margin:0 0 10px; }
    .time{ font-size:24px; font-weight:800; margin:10px 0 6px; }
    .loc{ font-size:18px; }
    .pill{
      margin:16px auto 4px; display:inline-block; padding:6px 14px;
      background:var(--busy); color:#fff; border-radius:999px; font-weight:800;
      letter-spacing:.3px;
    }

    /* Calendar */
    .calCard{
      width:100%;
      background:var(--card);
      border-radius:24px; box-shadow:var(--shadow);
      padding:22px 22px 26px;
      box-sizing:border-box;
    }
    .calHead{
      display:flex; justify-content:space-between; align-items:end;
      margin:6px 4px 12px 4px;
    }
    .calTitle{ font-size:28px; font-weight:900; letter-spacing:.3px; }
    .calMonth{ color:var(--muted); margin-top:6px; }
    .calendar{
      display:grid; gap:14px;
      grid-template-columns:repeat(7, 1fr);
      grid-auto-rows:minmax(92px, 1fr);
      user-select:none;
    }
    .dow{ color:var(--muted); font-weight:700; text-align:center; }
    .day{
      border-radius:16px; background:#f6f7fb; position:relative;
      padding:10px; box-sizing:border-box; overflow:hidden;
    }
    .num{ position:absolute; top:10px; right:14px; color:#9aa3af; font-weight:800; }
    .today{ outline:3px solid var(--accent); outline-offset:-3px; }
    .slot{
      display:block; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin-top:30px; /* first slot starts below number */
    }
    .tag{
      display:inline-block; background:var(--busy); color:#fff;
      border-radius:999px; padding:3px 10px; font-size:12px; font-weight:800;
    }

    /* Footer */
    .foot{
      width:100%; text-align:center; color:#98a2b3; font-size:13px; padding:8px 0 14px;
      user-select:none;
    }

    /* TV-safe overscan room */
    @media (min-width: 1200px){
      .stage{ padding:0 28px 18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="bar">
      <div class="brand">
        <img src="assets/TraccLogo1.png" alt="TRACC Civil" />
        <div class="title" id="podTitle">Pod</div>
      </div>
      <!-- empty right side for balance -->
      <div style="width:60px"></div>
    </div>

    <div class="stage">
      <!-- Slide 1: hero 01.jpg -->
      <section class="slide active" id="slide-hero-1">
        <div class="hero">
          <img id="hero1" alt="Pod image 1"/>
          <div class="heroTitle" id="hero1Title"></div>
        </div>
      </section>

      <!-- Slide 2: next booking -->
      <section class="slide" id="slide-next">
        <div class="cardWrap">
          <div class="card">
            <div class="h1">Next Booking</div>
            <div class="h2" id="nbWho">—</div>
            <div class="meta" id="nbOrg">—</div>
            <div class="time" id="nbWhen">—</div>
            <div class="loc" id="nbWhere">—</div>
            <div class="pill">Busy</div>
          </div>
        </div>
      </section>

      <!-- Slide 3: hero 02.jpg -->
      <section class="slide" id="slide-hero-2">
        <div class="hero">
          <img id="hero2" alt="Pod image 2"/>
          <div class="heroTitle" id="hero2Title"></div>
        </div>
      </section>

      <!-- Slide 4: monthly calendar -->
      <section class="slide" id="slide-cal">
        <div class="calCard">
          <div class="calHead">
            <div>
              <div class="calTitle">Monthly View</div>
              <div class="calMonth" id="calMonth">—</div>
            </div>
          </div>
          <div class="calendar" id="calendar">
            <!-- DOW row -->
          </div>
        </div>
      </section>

      <!-- Slide 5: hero 03.jpg -->
      <section class="slide" id="slide-hero-3">
        <div class="hero">
          <img id="hero3" alt="Pod image 3"/>
          <div class="heroTitle" id="hero3Title"></div>
        </div>
      </section>
    </div>

    <div class="foot">© Tracc Civil | Pod Display System</div>
  </div>

  <script>
    /* ------------------ helpers ------------------ */
    const TZ = 'Australia/Perth';

    // Parse "dd/MM/yyyy HH:mm" as UTC -> Date
    function parseUtcDDMM(str){
      // "12/11/2025 02:30"
      const [d, m, yAndTime] = str.split('/');
      const y = yAndTime.slice(0,4);
      const time = yAndTime.slice(5);
      const [hh, mm] = time.split(':');
      const dt = new Date(Date.UTC(Number(y), Number(m)-1, Number(d), Number(hh), Number(mm)));
      return dt;
    }

    function fmtDatePerth(date){
      return new Intl.DateTimeFormat('en-AU', {
        timeZone: TZ, weekday:'short', day:'2-digit', month:'short', year:'numeric'
      }).format(date);
    }
    function fmtTimePerth(date){
      return new Intl.DateTimeFormat('en-AU', {
        timeZone: TZ, hour:'2-digit', minute:'2-digit', hour12:false
      }).format(date);
    }
    function toPerth(date){ // returns Date object shifted to Perth clock (for day comparisons)
      // We'll derive Y/M/D/H/M in Perth using Intl and rebuild a local Date for placement logic
      const f = new Intl.DateTimeFormat('en-CA', {
        timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false
      });
      const parts = f.formatToParts(date).reduce((o,p)=> (o[p.type]=p.value, o), {});
      return new Date(Number(parts.year), Number(parts.month)-1, Number(parts.day), Number(parts.hour), Number(parts.minute));
    }

    function qs(id){ return document.getElementById(id); }

    /* ------------------ config / pod ------------------ */
    const params = new URLSearchParams(location.search);
    const podKey = (params.get('pod') || '').replace(/\s+/g,'');
    const settingsUrl = 'config/settings.json';

    let podCfg = null;
    let events = []; // normalized event objects in Perth

    /* ------------------ slides ------------------ */
    const slides = [
      { id:'slide-hero-1', dur:10000 },
      { id:'slide-next',   dur:15000 },
      { id:'slide-hero-2', dur:15000 },
      { id:'slide-cal',    dur:15000 },
      { id:'slide-hero-3', dur:15000 },
    ];
    let slideIdx = 0, timer = null;

    function show(i){
      document.querySelectorAll('.slide').forEach(el=>el.classList.remove('active'));
      const s = slides[i];
      qs(s.id).classList.add('active');
      clearTimeout(timer);
      timer = setTimeout(()=>{
        slideIdx = (i+1) % slides.length;
        show(slideIdx);
      }, s.dur);
    }

    /* ------------------ data load ------------------ */
    async function loadSettings(){
      const res = await fetch(settingsUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('settings.json not found');
      const cfg = await res.json();
      const map = cfg.pods || {};
      if(!map[podKey]) throw new Error('Unknown pod: ' + podKey);
      podCfg = map[podKey];
      // UI text & images
      const podName = podCfg.displayName || podKey;
      qs('podTitle').textContent = podName;
      qs('hero1Title').textContent = podName;
      qs('hero2Title').textContent = podName;
      qs('hero3Title').textContent = podName;

      qs('hero1').src = `Pod-Images/${podKey}/01.jpg`;
      qs('hero2').src = `Pod-Images/${podKey}/02.jpg`;
      qs('hero3').src = `Pod-Images/${podKey}/03.jpg`;
    }

    async function loadEvents(){
      const res = await fetch(podCfg.endpoint, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: '{}',
        cache:'no-store'
      });
      if(!res.ok) throw new Error('Endpoint error');
      const raw = await res.json(); // array of {subject, organizer, start, end, location}
      // normalize into Perth
      events = raw.map(e=>{
        const startUtc = parseUtcDDMM(e.start);
        const endUtc   = parseUtcDDMM(e.end);
        const startP   = toPerth(startUtc);
        const endP     = toPerth(endUtc);
        return {
          title: (e.subject || '').trim(),
          organizer: (e.organizer || '').trim(),
          location: (e.location || '').trim(),
          startUtc, endUtc, startP, endP
        };
      }).sort((a,b)=> a.startP - b.startP);
    }

    /* ------------------ renderers ------------------ */
    function renderNext(){
      const now = new Date();
      const nowPerth = toPerth(now);
      const next = events.find(e => e.endP > nowPerth);
      if(!next){
        qs('nbWho').textContent = 'No upcoming bookings';
        qs('nbOrg').textContent = '';
        qs('nbWhen').textContent = '';
        qs('nbWhere').textContent = '';
        return;
      }
      qs('nbWho').textContent = next.title || '—';
      qs('nbOrg').textContent = next.organizer ? `Organizer: ${next.organizer}` : '';
      qs('nbWhen').textContent = `${fmtDatePerth(next.startUtc)} — ${fmtTimePerth(next.startUtc)} – ${fmtTimePerth(next.endUtc)}`;
      qs('nbWhere').textContent = next.location ? `Location: ${next.location}` : '';
    }

    function renderCalendar(){
      const cal = qs('calendar');
      cal.innerHTML = '';

      // Header row (DOW)
      const dows = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      for(const d of dows){
        const el = document.createElement('div');
        el.className='dow';
        el.textContent=d;
        cal.appendChild(el);
      }

      // current month in Perth
      const todayPerth = toPerth(new Date());
      qs('calMonth').textContent = new Intl.DateTimeFormat('en-AU', {
        timeZone: TZ, month:'long', year:'numeric'
      }).format(todayPerth);

      const y = todayPerth.getFullYear();
      const m = todayPerth.getMonth();
      const first = new Date(y, m, 1);
      const firstDow = first.getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();

      // pad first week
      for(let i=0;i<firstDow;i++){
        const pad = document.createElement('div');
        pad.className='day';
        pad.style.visibility='hidden';
        cal.appendChild(pad);
      }

      // group events by day (Perth)
      const map = {};
      for(const ev of events){
        const d = ev.startP.getDate();
        const mo = ev.startP.getMonth();
        const yr = ev.startP.getFullYear();
        if(mo===m && yr===y){
          const key = d;
          (map[key] = map[key] || []).push(ev);
        }
      }

      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div');
        cell.className='day';
        const num = document.createElement('div');
        num.className='num';
        num.textContent = d;
        cell.appendChild(num);

        // today outline
        if(d===todayPerth.getDate()) cell.classList.add('today');

        const items = (map[d] || []).sort((a,b)=> a.startP - b.startP);
        let offset = 30;
        for(const ev of items){
          const s = `${fmtTimePerth(ev.startUtc)} – ${fmtTimePerth(ev.endUtc)}`
          const line = document.createElement('div');
          line.className='slot';
          line.style.marginTop = offset+'px';
          const tag = document.createElement('span');
          tag.className='tag';
          tag.textContent = `${s} · Busy`;
          line.appendChild(tag);
          cell.appendChild(line);
          offset += 24; // stack neatly
        }

        cal.appendChild(cell);
      }
    }

    /* ------------------ boot ------------------ */
    (async function(){
      try{
        await loadSettings();
        await loadEvents();
        renderNext();
        renderCalendar();
        show(0); // kick slideshow
      }catch(err){
        alert(err.message || err);
      }
    })();
  </script>
</body>
</html>
