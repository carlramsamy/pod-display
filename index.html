<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pod Display</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: hidden;
    }

    #logo {
      position: absolute;
      top: 20px;
      right: 30px;
      width: 140px;
    }

    #podName {
      font-size: 2.8em;
      font-weight: 700;
      margin-top: 20px;
      text-align: center;
    }

    #stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .card {
      background: #f9f9f9;
      border-radius: 16px;
      padding: 25px 35px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.1);
      text-align: center;
    }

    h2 {
      margin: 0 0 10px 0;
      font-size: 1.6em;
    }

    p {
      margin: 5px 0;
      font-size: 1.1em;
    }
  </style>
</head>

<body>
  <img id="logo" src="assets/TraccLogo1.png" alt="TRACC CIVIL Logo">
  <div id="podName">Loading...</div>
  <div id="stage">Loading content...</div>

  <script>
  async function init() {
    const params = new URLSearchParams(window.location.search);
    const podName = params.get("pod");
    const title = document.getElementById("podName");
    const stage = document.getElementById("stage");

    const res = await fetch("config/settings.json");
    const cfg = await res.json();
    const pod = cfg.pods[podName];
    if (!pod) {
      title.textContent = "Pod not found";
      stage.innerHTML = "<p>Use ?pod=FernsPool | ElephantRocks | LuckyBay</p>";
      return;
    }
    title.textContent = pod.displayName;

    const images = ["01.jpg", "02.jpg", "03.jpg"].map(i => pod.imagesPath + i);

    async function getEvents() {
      try {
        const r = await fetch(pod.endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}"
        });
        const d = await r.json();
        if (Array.isArray(d)) return d;
        if (Array.isArray(d.value)) return d.value;
        return [];
      } catch (e) {
        console.log("fetch error", e);
        return [];
      }
    }

    function normalize(ev) {
      return {
        subject: ev.subject || ev.Subject || ev.organizer || ev.Organizer || "Unknown",
        start: ev.start || ev.Start || "",
        end: ev.end || ev.End || "",
        location: ev.location || ev.Location || ""
      };
    }

    function watermark(bgHTML) {
      const src = images[Math.floor(Math.random() * images.length)];
      return `
        <div style="position:relative;width:100%;height:80vh;display:flex;align-items:center;justify-content:center;">
          <img src='${src}' style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:.25;filter:blur(4px);z-index:0;">
          <div style="position:relative;z-index:2;">${bgHTML}</div>
        </div>
      `;
    }

    function showNext(ev) {
      if (!ev) {
        return watermark("<div class='card'><h2>No upcoming bookings</h2></div>");
      }
      ev = normalize(ev);
      const html = `
        <div class='card' style="max-width:420px;margin:auto;">
          <h2>Up Next</h2>
          <p><strong>${ev.subject}</strong></p>
          <p>${ev.start} - ${ev.end}</p>
          <p>${ev.location}</p>
        </div>`;
      return watermark(html);
    }

    function showMonth(events) {
      const now = new Date();
      const year = now.getFullYear(), month = now.getMonth();
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const booked = new Set();
      events.forEach(e => {
        const ev = normalize(e);
        const [d, m, y] = (ev.start || "").split(" ")[0].split("/").map(Number);
        if (y === year && m - 1 === month) booked.add(d);
      });

      let html = `<div class='card' style="padding:40px;display:inline-block;background:#fff;">
        <h2 style="margin-bottom:20px;">${now.toLocaleString('en-AU', { month: 'long', year: 'numeric' })}</h2>
        <div style="display:grid;grid-template-columns:repeat(7,7vh);gap:1vh;justify-content:center;margin-top:10px;">`;
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      days.forEach(d => html += `<div style="text-align:center;font-weight:bold;">${d}</div>`);
      for (let i = 0; i < first.getDay(); i++) html += "<div></div>";
      for (let d = 1; d <= last.getDate(); d++) {
        const mark = booked.has(d)
          ? "background:#2e7d32;color:#fff;border-radius:6px;font-weight:bold;"
          : "background:#f5f5f5;color:#333;";
        html += `<div style="text-align:center;padding:1.2vh;font-size:2vh;${mark}">${d}</div>`;
      }
      html += "</div></div>";
      return html;
    }

    function showImage(i) {
      return `
        <div style="width:100%;height:80vh;display:flex;align-items:center;justify-content:center;">
          <img src="${images[i]}" style="max-height:80vh;max-width:90vw;border-radius:20px;object-fit:cover;box-shadow:0 8px 25px rgba(0,0,0,.25);">
        </div>`;
    }

    let idx = 0;
    let events = [];

    async function cycle() {
      const mode = idx % 3;
      if (mode === 0) stage.innerHTML = showImage((idx / 3) % images.length | 0);
      else if (mode === 1) stage.innerHTML = showNext(events[0]);
      else stage.innerHTML = showMonth(events);
      idx++;
      setTimeout(cycle, 10000);
    }

    events = await getEvents();
    cycle();
  }
  init();
  </script>
</body>
</html>
