<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pod Display</title>
  <style>
    body {
      margin: 0;
      background-color: white;
      overflow: hidden;
      font-family: "Segoe UI", Arial, sans-serif;
      color: #222;
    }

    .slide {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: white;
      opacity: 0;
      transition: opacity 1s ease;
    }

    .active {
      opacity: 1;
      z-index: 2;
    }

    .hero-image {
      position: relative;
      width: 95%;
      height: 85%;
      object-fit: contain;
      border-radius: 20px;
      border: 8px solid white;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .pod-name {
      position: absolute;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 3vw;
      font-weight: bold;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
    }

    .logo {
      position: absolute;
      top: 3%;
      right: 3%;
      width: 150px;
      opacity: 0.95;
    }

    footer {
      position: absolute;
      bottom: 2%;
      width: 100%;
      text-align: center;
      font-size: 1.2vw;
      color: #444;
    }

    /* Booking overlay slide */
    .overlay-container {
      position: relative;
      width: 95%;
      height: 85%;
      border-radius: 20px;
      overflow: hidden;
      border: 8px solid white;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .overlay-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(60%);
    }

    .overlay-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 65%;
      background: rgba(255,255,255,0.85);
      padding: 20px 30px;
      border-radius: 15px;
      text-align: left;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .overlay-box h2 {
      text-align: center;
      margin-top: 0;
      color: #222;
      font-size: 2vw;
    }

    .booking-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.4vw;
    }

    .booking-grid th, .booking-grid td {
      padding: 6px 10px;
      border-bottom: 1px solid #ccc;
    }

    .free { background: transparent; }
    .booked { background: #ffdddd; }
    .inprogress { background: #d5fdd5; }
    .completed { background: #e0e0e0; }
  </style>
</head>
<body>
  <img class="logo" src="assets/TraccLogo1.png" alt="Tracc Logo" />
  <div id="slides"></div>
  <footer>Tracc Civil Pod Display System</footer>

  <script>
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const podKey = params.get("pod") || "FernsPool";
      const settings = await fetch("config/settings.json").then(r => r.json());
      const pod = settings.pods[podKey];
      const endpoint = pod.endpoint;
      const imagesPath = pod.imagesPath;

      const bookings = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      }).then(r => r.json()).catch(() => []);

      // Convert UTC times to AWST
      const toAWST = utc => {
        const d = new Date(utc + "Z");
        return new Date(d.toLocaleString("en-US", { timeZone: "Australia/Perth" }));
      };

      const today = new Date();
      const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 8, 0, 0);
      const slots = [];
      for (let h = 8; h < 17; h++) {
        const start = new Date(startOfDay.getTime());
        start.setHours(h, 0, 0);
        const end = new Date(start.getTime());
        end.setHours(h + 1, 0, 0);
        slots.push({ start, end, label: `${String(h).padStart(2,"0")}:00 - ${String(h+1).padStart(2,"0")}:00`, status:"free", who:"" });
      }

      // Mark slots based on bookings
      bookings.forEach(b => {
        const start = toAWST(b.start.replace(" ", "T"));
        const end = toAWST(b.end.replace(" ", "T"));
        const now = new Date();
        if (start.toDateString() !== today.toDateString()) return;

        slots.forEach(s => {
          if (end <= s.start) return;
          if (start >= s.end) return;
          if (now >= start && now <= end) s.status = "inprogress";
          else if (now > end) s.status = "completed";
          else s.status = "booked";
          s.who = b.organizer.trim();
        });
      });

      // Build slide HTML
      const slidesHTML = `
        <div class="slide active">
          <img src="${imagesPath}01.jpg" class="hero-image" alt="">
          <div class="pod-name">${pod.displayName}</div>
        </div>
        <div class="slide">
          <div class="overlay-container">
            <img src="${imagesPath}02.jpg" class="overlay-bg" alt="">
            <div class="overlay-box">
              <h2>${today.toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'})} â€“ Bookings</h2>
              <table class="booking-grid">
                ${slots.map(s => `
                  <tr class="${s.status}">
                    <td>${s.label}</td>
                    <td>${s.who || 'Free'}</td>
                  </tr>
                `).join('')}
              </table>
            </div>
          </div>
        </div>
        <div class="slide">
          <img src="${imagesPath}03.jpg" class="hero-image" alt="">
          <div class="pod-name">${pod.displayName}</div>
        </div>
      `;

      const slidesContainer = document.getElementById("slides");
      slidesContainer.innerHTML = slidesHTML;

      const slides = document.querySelectorAll(".slide");
      let idx = 0;
      setInterval(() => {
        slides[idx].classList.remove("active");
        idx = (idx + 1) % slides.length;
        slides[idx].classList.add("active");
      }, 15000);
    }
    init();
  </script>
</body>
</html>
