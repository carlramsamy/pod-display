<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pod Display</title>
<link rel="preload" href="assets/TraccLogo1.png" as="image" />
<style>
  :root{
    --border-radius: 22px;
    --card-radius: 18px;
    --shadow: 0 10px 30px rgba(0,0,0,0.12);
    --shadow-heavy: 0 20px 60px rgba(0,0,0,0.18);
    --text: #222;
    --muted: #6b7280;
    --green: #2e7d32;
    --bg:#ffffff;
    --panel:#f7f7f7;
    --maxw: 1780px;
    --content-w: 1620px;
    --bottom-clear: 54px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  .frame{
    min-height:100vh; padding:18px;
    display:flex; align-items:center; justify-content:center;
  }
  .canvas{
    width:100%; max-width:var(--maxw);
    border-radius:var(--border-radius);
    background:var(--panel);
    box-shadow:var(--shadow-heavy);
    position:relative; overflow:hidden;
    padding:22px; padding-bottom:calc(22px + var(--bottom-clear));
  }
  .brand{
    position:absolute; top:22px; right:22px;
    height:40px; width:auto; object-fit:contain;
  }
  .slide{
    width:100%;
    height:calc(100vh - 2*18px - 2*22px - var(--bottom-clear));
    max-height:850px;
    display:flex; align-items:center; justify-content:center;
  }
  .photoWrap{
    width:100%; max-width:var(--content-w); height:100%;
    border-radius:16px; overflow:hidden; position:relative;
    display:flex; align-items:center; justify-content:center;
    background:#000; box-shadow:var(--shadow);
  }
  .photo{ width:100%; height:100%; object-fit:cover; }

  .titleOverlay{
    position:absolute; top:18px; left:50%; transform:translateX(-50%);
    color:#fff; font-weight:800; letter-spacing:0.3px;
    font-size: clamp(28px, 3.7vw, 56px);
    text-shadow: 0 2px 18px rgba(0,0,0,0.45), 0 1px 2px rgba(0,0,0,0.6);
    padding:6px 14px; border-radius:10px;
  }

  .card{ position:absolute; background:rgba(255,255,255,0.92);
    border-radius:var(--card-radius); box-shadow:var(--shadow-heavy);
    color:#1f2937; max-width:980px; width:min(92%, 980px);
  }
  .card.center{left:50%; top:50%; transform:translate(-50%,-50%);}
  .card.pad{padding:28px 32px;}
  .card h2{ margin:0 0 12px; font-size: clamp(24px, 3.2vw, 44px); text-align:center; }
  .meta{ text-align:center; color:#374151; font-size:clamp(16px, 1.4vw, 20px)}
  .status{
    display:inline-block; margin-top:14px; padding:8px 14px; border-radius:999px;
    color:#fff; background:var(--green); font-weight:700; font-size:clamp(14px,1.2vw,18px)
  }
  .status.badge{ background:#A3A3A3 }
  .status.progress{ background:#e11d48 }

  .grid{ width:100%; border-collapse:collapse; margin-top:6px;
    font-size:clamp(16px,1.5vw,22px);
  }
  .grid th,.grid td{ padding:14px 18px; }
  .grid tr+tr td{ border-top:1px solid rgba(0,0,0,0.08) }
  .grid .time{ color:#111; font-weight:700; width:40% }
  .grid .who.free{ color:var(--muted) }
  .grid .who.busy{ color:#0f5132; font-weight:700 }
  .grid .who.progress{ color:#b91c1c; font-weight:800 }

  .footer{
    position:absolute; left:0; right:0; bottom:12px;
    text-align:center; color:#6b7280; font-size:14px;
  }
</style>
</head>
<body>
  <div class="frame">
    <div class="canvas">
      <img class="brand" src="assets/TraccLogo1.png" alt="TRACC CIVIL" />
      <div id="slide" class="slide"></div>
      <div class="footer">© Tracc Civil | Pod Display System</div>
    </div>
  </div>

<script>
/* ========== CONSTANTS ========== */
const AWTZ = 'Australia/Perth';
const WORK_START = {h:8, m:0};
const WORK_END   = {h:17, m:0};

const qs = new URLSearchParams(location.search);
const podKey = (qs.get('pod')||'').trim() || 'FernsPool';

/* ========== HELPERS ========== */
async function loadSettings(){
  const r = await fetch('config/settings.json', {cache:'no-store'});
  if(!r.ok) throw new Error('Cannot load settings.json');
  return r.json();
}

function parseFlowUTC(s){
  const [d,m,rest] = s.trim().split('/');
  const [yyyy,time] = rest.split(' ');
  const [hh,mm] = time.split(':');
  return new Date(Date.UTC(+yyyy, (+m)-1, +d, +hh, +mm, 0));
}

function parseEvents(raw){
  return (raw||[]).map(ev=>{
    return {
      subject: (ev.subject||'').trim(),
      organizer: (ev.organizer||'').trim(),
      location: (ev.location||'').trim(),
      start: parseFlowUTC(ev.start),
      end:   parseFlowUTC(ev.end),
    };
  }).sort((a,b)=>a.start-b.start);
}

function isSameDayAW(a,b){
  const f = (d)=> new Intl.DateTimeFormat('en-AU',{timeZone:AWTZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(d);
  return f(a)===f(b);
}

function fmtRangeAW(a,b,{compact=false}={}){
  const tf = new Intl.DateTimeFormat('en-AU',{timeZone:AWTZ, hour:'2-digit', minute:'2-digit'});
  const df = new Intl.DateTimeFormat('en-AU',{timeZone:AWTZ, day:'2-digit', month:'long', year:'numeric'});
  const t = d => tf.format(d).replace(' ','');
  if(compact) return `${t(a)}–${t(b)}`;
  return {date: df.format(a), time: `${t(a)}–${t(b)}`};
}

function awDayStart(d,{h,m}){
  const parts = new Intl.DateTimeFormat('en-AU',{timeZone:AWTZ, year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(d);
  const y = parts.find(p=>p.type==='year').value;
  const mo= parts.find(p=>p.type==='month').value;
  const da= parts.find(p=>p.type==='day').value;
  return new Date(`${y}-${mo}-${da}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
}

function buildDaySchedule(events, day){
  const startDay = awDayStart(day, WORK_START);
  const endDay   = awDayStart(day, WORK_END);
  const todays = events.filter(e=>isSameDayAW(e.start, day));
  const blocks=[];
  let cursor = new Date(startDay);
  for(const e of todays){
    const s = new Date(Math.max(e.start.getTime(), startDay.getTime()));
    const en= new Date(Math.min(e.end.getTime(),   endDay.getTime()));
    if(en <= startDay) continue;
    if(s > cursor){ blocks.push({type:'free', start:new Date(cursor), end:new Date(s)}); }
    if(en > s){
      blocks.push({
        type:'busy',
        start:new Date(s),
        end:new Date(en),
        who: (e.subject||e.organizer||'Booked').trim()
      });
      cursor = new Date(en);
    }
  }
  if(cursor < endDay){ blocks.push({type:'free', start:new Date(cursor), end:new Date(endDay)}); }
  return blocks.filter(b => b.end - b.start >= 60*1000);
}

function getTodayStatus(events, now){
  const today = events.filter(e=>isSameDayAW(e.start, now)).sort((a,b)=>a.start-b.start);
  for(const e of today){
    if(now>=e.start && now<=e.end) return {mode:'progress', ev:e};
    if(e.start>now) return {mode:'next', ev:e};
  }
  return {mode:'none', ev:null};
}

function el(tag, cls, html){
  const x=document.createElement(tag);
  if(cls) x.className=cls;
  if(html!=null) x.innerHTML=html;
  return x;
}

/* Slides */
function imageSlide({title, src}){
  const wrap = el('div','photoWrap');
  const img = el('img','photo'); img.src=src; img.alt=title||'';
  wrap.append(img, el('div','titleOverlay', title||''));
  return wrap;
}
function nextBookingSlide({ev, mode, bg, title}){
  const wrap = el('div','photoWrap');
  wrap.appendChild(Object.assign(el('img','photo'),{src:bg,alt:''}));
  const card = el('div','card center pad');
  card.append(el('h2',null,'Next Booking'));
  const name = ev ? (ev.subject||ev.organizer||'').trim() : '';
  if(name) card.append(el('div','meta', `<div style="font-weight:800; font-size:clamp(22px,2.2vw,30px); margin-top:4px">${name}</div>`));
  const info = ev
    ? (()=>{const {date,time}=fmtRangeAW(ev.start,ev.end); return `<div class="meta" style="margin-top:6px">${date} — ${time}</div>`})()
    : `<div class="meta" style="margin-top:6px">No bookings today</div>`;
  card.append(el('div',null,info));
  card.append(el('div','status '+(mode==='progress'?'progress':(ev?'':'badge')), ev ? (mode==='progress'?'In progress':'Upcoming') : 'Free all day'));
  wrap.append(card, el('div','titleOverlay', title||''));
  return wrap;
}
function scheduleSlide({title, blocks, bg}){
  const wrap = el('div','photoWrap');
  wrap.appendChild(Object.assign(el('img','photo'),{src:bg,alt:''}));
  const card = el('div','card center pad');
  const ref = blocks[0]?.start || new Date();
  const df = new Intl.DateTimeFormat('en-AU',{timeZone:AWTZ, day:'2-digit', month:'long', year:'numeric'});
  card.append(el('h2',null, `${df.format(ref)} — Bookings`));
  const table = el('table','grid');
  for(const b of blocks){
    const row = el('tr');
    const {time} = fmtRangeAW(b.start,b.end);
    row.append(el('td','time', time));
    const cls = b.type==='busy' ? ((new Date()>=b.start && new Date()<=b.end) ? 'who progress' : 'who busy') : 'who free';
    row.append(el('td',cls, b.type==='busy' ? (b.who||'Booked') : 'Free'));
    table.append(row);
  }
  card.appendChild(table);
  wrap.append(card, el('div','titleOverlay', title||''));
  return wrap;
}

async function firstExisting(urls){
  for(const u of urls){
    try{ const r=await fetch(u,{method:'HEAD',cache:'no-store'}); if(r.ok) return u; }catch{}
  }
  return urls[0];
}
async function threeImages(base){
  const b = base.endsWith('/')?base:base+'/';
  const a = await firstExisting([`${b}01.jpg`,`${b}01.jpeg`]);
  const c = await firstExisting([`${b}02.jpg`,`${b}02.jpeg`]);
  const d = await firstExisting([`${b}03.jpg`,`${b}03.jpeg`]);
  return [a,c,d];
}

/* ========== MAIN ========== */
(async()=>{
  const settings = await loadSettings();
  const pod = settings.pods[podKey];
  if(!pod){ document.getElementById('slide').textContent=`Unknown pod: ${podKey}`; return; }

  const [img1,img2,img3] = await threeImages(pod.imagesPath);

  let events=[];
  try{
    const r = await fetch(pod.endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const raw = await r.json();
    events = parseEvents(raw);
  }catch(e){ console.warn('Flow fetch failed', e); }

  const now = new Date();
  const schedule = buildDaySchedule(events, now);
  const {mode, ev} = getTodayStatus(events, now);

  const slideHost = document.getElementById('slide');
  const slides = [
    ()=>imageSlide({title:pod.displayName, src:img1}),
    ()=>nextBookingSlide({ev, mode, bg:img2, title:pod.displayName}),
    ()=>scheduleSlide({title:pod.displayName, blocks:schedule, bg:img3}),
    ()=>imageSlide({title:pod.displayName, src:img2}),
    ()=>imageSlide({title:pod.displayName, src:img3}),
  ];
  const durations=[10000,12000,15000,10000,10000];

  let i=0, t=null;
  const show=(n)=>{
    i=n%slides.length; slideHost.innerHTML='';
    slideHost.appendChild(slides[i]());
    clearTimeout(t); t=setTimeout(()=>show(i+1), durations[i]);
  };
  show(0);

  /* === AUTO REFRESH EVERY 15 MINUTES WITH STAGGER === */
  const REFRESH_INTERVAL_MS = 15 * 60 * 1000;
  const podOffsets = {
    'FernsPool': 0,          // refresh every 15 mins on the hour
    'LuckyBay':  5 * 60 * 1000,  // +5 min
    'ElephantRocks': 10 * 60 * 1000 // +10 min
  };
  const offset = podOffsets[podKey] || 0;
  console.log(`Auto-refresh for ${podKey} every 15 mins, offset ${offset/60000} mins`);

  setTimeout(()=>{
    setInterval(()=>{
      console.log(`Refreshing ${podKey} for updated data...`);
      const url = new URL(window.location.href);
      url.searchParams.set('cacheBust', Date.now());
      window.location.replace(url.toString());
    }, REFRESH_INTERVAL_MS);
  }, offset);
})();
</script>
</body>
</html>
