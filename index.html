<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="color-scheme" content="light only"/>
<title>Pod Display</title>
<style>
:root{
  --brand:#0a2540;
  --ink:#111;
  --muted:#666;
  --card:#fff;
  --bg:#fff;
  --busy:#2e7d32;
  --shadow:0 6px 18px rgba(16,24,40,0.08);
}
html,body{
  margin:0;padding:0;height:100%;
  background:var(--bg);color:var(--ink);
  font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  overflow:hidden;
}

/* --- LOGO fixed top centre --- */
.logoFixed{
  position:fixed;top:12px;left:50%;
  transform:translateX(-50%);
  z-index:20;
  background:#fff;
  border-radius:14px;
  padding:6px 12px;
  box-shadow:var(--shadow);
}
.logoFixed img{height:48px;width:auto;display:block;}

/* --- Slides --- */
.stage{
  margin-top:70px;
  width:100%;height:calc(100vh - 70px);
}
.slide{display:none;}
.slide.active{display:block;}

/* Hero slides */
.hero{
  position:relative;
  width:100%;height:100%;
  border-radius:24px;overflow:hidden;
  background:#fff;box-shadow:var(--shadow);
}
.hero img{width:100%;height:100%;object-fit:cover;}
.heroTitle{
  position:absolute;top:24px;width:100%;
  text-align:center;font-size:48px;font-weight:800;color:#fff;
  text-shadow:0 2px 8px rgba(0,0,0,0.4);
}

/* Next Booking */
.cardWrap{display:flex;align-items:center;justify-content:center;height:100%;}
.card{
  width:min(880px,92vw);
  background:#fff;border-radius:24px;
  box-shadow:var(--shadow);
  padding:32px 36px;text-align:center;
}
.h1{font-size:42px;font-weight:900;margin:0 0 10px;}
.h2{font-size:26px;font-weight:800;margin:12px 0 4px;}
.meta{color:var(--muted);font-size:18px;margin:0 0 10px;}
.time{font-size:24px;font-weight:800;margin:10px 0 6px;}
.loc{font-size:18px;}
.pill{
  margin:16px auto 4px;display:inline-block;padding:6px 14px;
  background:var(--busy);color:#fff;border-radius:999px;font-weight:800;
}

/* Calendar */
.calCard{
  background:#fff;border-radius:24px;
  box-shadow:var(--shadow);
  width:420px;height:570px; /* ≈22cm x 30cm at 96dpi */
  margin:0 auto;
  padding:18px 18px 22px;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
}
.calHead{text-align:center;margin-bottom:8px;}
.calTitle{font-size:26px;font-weight:900;}
.calMonth{color:var(--muted);}
.calendar{
  display:grid;gap:6px;
  grid-template-columns:repeat(7,1fr);
  grid-auto-rows:minmax(40px,1fr);
  width:100%;
  height:calc(100% - 60px);
}
.dow{text-align:center;font-weight:700;color:var(--muted);font-size:13px;}
.day{
  border-radius:8px;background:#f6f7fb;
  position:relative;padding:4px;box-sizing:border-box;
  overflow:hidden;font-size:12px;
}
.num{position:absolute;top:3px;right:6px;color:#9aa3af;font-weight:800;font-size:11px;}
.today{outline:2px solid #0b5fff;outline-offset:-2px;}
.slot{margin-top:18px;}
.tag{
  display:inline-block;background:var(--busy);color:#fff;
  border-radius:999px;padding:2px 6px;
  font-size:10px;font-weight:800;
}

/* Footer */
.foot{width:100%;text-align:center;color:#98a2b3;font-size:13px;padding:8px 0 14px;}
</style>
</head>
<body>
  <!-- Fixed centered logo -->
  <div class="logoFixed">
    <img src="assets/TraccLogo1.png" alt="TRACC Civil">
  </div>

  <div class="stage">
    <!-- 1: Hero 01 -->
    <section class="slide active" id="slide-hero-1">
      <div class="hero"><img id="hero1"><div class="heroTitle" id="hero1Title"></div></div>
    </section>

    <!-- 2: Next Booking -->
    <section class="slide" id="slide-next">
      <div class="cardWrap">
        <div class="card">
          <div class="h1">Next Booking</div>
          <div class="h2" id="nbWho">—</div>
          <div class="meta" id="nbOrg">—</div>
          <div class="time" id="nbWhen">—</div>
          <div class="loc" id="nbWhere">—</div>
          <div class="pill">Busy</div>
        </div>
      </div>
    </section>

    <!-- 3: Hero 02 -->
    <section class="slide" id="slide-hero-2">
      <div class="hero"><img id="hero2"><div class="heroTitle" id="hero2Title"></div></div>
    </section>

    <!-- 4: Calendar -->
    <section class="slide" id="slide-cal">
      <div class="calCard">
        <div class="calHead">
          <div class="calTitle">Monthly View</div>
          <div class="calMonth" id="calMonth">—</div>
        </div>
        <div class="calendar" id="calendar"></div>
      </div>
    </section>

    <!-- 5: Hero 03 -->
    <section class="slide" id="slide-hero-3">
      <div class="hero"><img id="hero3"><div class="heroTitle" id="hero3Title"></div></div>
    </section>
  </div>

  <div class="foot">© Tracc Civil | Pod Display System</div>

<script>
const TZ='Australia/Perth';
function parseUtcDDMM(str){
  const [d,m,yTime]=str.split('/');
  const y=yTime.slice(0,4);
  const t=yTime.slice(5);
  const [hh,mm]=t.split(':');
  return new Date(Date.UTC(+y,+m-1,+d,+hh,+mm));
}
function fmtDate(d){return new Intl.DateTimeFormat('en-AU',{timeZone:TZ,weekday:'short',day:'2-digit',month:'short',year:'numeric'}).format(d);}
function fmtTime(d){return new Intl.DateTimeFormat('en-AU',{timeZone:TZ,hour:'2-digit',minute:'2-digit',hour12:false}).format(d);}
function toPerth(date){
  const f=new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
  const p=f.formatToParts(date).reduce((o,a)=>(o[a.type]=a.value,o),{});
  return new Date(+p.year,+p.month-1,+p.day,+p.hour,+p.minute);
}
const qs=id=>document.getElementById(id);
const params=new URLSearchParams(location.search);
const podKey=(params.get('pod')||'').replace(/\s+/g,'');
const settingsUrl='config/settings.json';
let podCfg=null,events=[];
const slides=[
  {id:'slide-hero-1',dur:10000},
  {id:'slide-next',dur:15000},
  {id:'slide-hero-2',dur:15000},
  {id:'slide-cal',dur:15000},
  {id:'slide-hero-3',dur:15000}
];
let slideIdx=0,timer=null;
function show(i){
  document.querySelectorAll('.slide').forEach(e=>e.classList.remove('active'));
  const s=slides[i];qs(s.id).classList.add('active');
  clearTimeout(timer);
  timer=setTimeout(()=>{slideIdx=(i+1)%slides.length;show(slideIdx);},s.dur);
}
async function loadSettings(){
  const r=await fetch(settingsUrl,{cache:'no-store'});if(!r.ok)throw new Error('settings.json missing');
  const cfg=await r.json();const map=cfg.pods||{};
  if(!map[podKey])throw new Error('Unknown pod '+podKey);
  podCfg=map[podKey];
  const name=podCfg.displayName||podKey;
  ['hero1Title','hero2Title','hero3Title'].forEach(id=>qs(id).textContent=name);
  qs('hero1').src=`Pod-Images/${podKey}/01.jpg`;
  qs('hero2').src=`Pod-Images/${podKey}/02.jpg`;
  qs('hero3').src=`Pod-Images/${podKey}/03.jpg`;
}
async function loadEvents(){
  const r=await fetch(podCfg.endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:'{}',cache:'no-store'});
  if(!r.ok)throw new Error('endpoint error');
  const raw=await r.json();
  events=raw.map(e=>{
    const su=parseUtcDDMM(e.start),eu=parseUtcDDMM(e.end);
    const sp=toPerth(su),ep=toPerth(eu);
    return{title:e.subject||'',organizer:e.organizer||'',location:e.location||'',startUtc:su,endUtc:eu,startP:sp,endP:ep};
  }).sort((a,b)=>a.startP-b.startP);
}
function renderNext(){
  const now=toPerth(new Date());
  const next=events.find(e=>e.endP>now);
  if(!next){qs('nbWho').textContent='No upcoming bookings';return;}
  qs('nbWho').textContent=next.title;
  qs('nbOrg').textContent=next.organizer?`Organizer: ${next.organizer}`:'';
  qs('nbWhen').textContent=`${fmtDate(next.startUtc)} — ${fmtTime(next.startUtc)} – ${fmtTime(next.endUtc)}`;
  qs('nbWhere').textContent=next.location?`Location: ${next.location}`:'';
}
function renderCalendar(){
  const cal=qs('calendar');cal.innerHTML='';
  const dows=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  dows.forEach(d=>{const el=document.createElement('div');el.className='dow';el.textContent=d;cal.appendChild(el);});
  const today=toPerth(new Date());
  qs('calMonth').textContent=new Intl.DateTimeFormat('en-AU',{timeZone:TZ,month:'long',year:'numeric'}).format(today);
  const y=today.getFullYear(),m=today.getMonth();
  const first=new Date(y,m,1),firstDow=first.getDay(),daysInMonth=new Date(y,m+1,0).getDate();
  for(let i=0;i<firstDow;i++){const pad=document.createElement('div');pad.className='day';pad.style.visibility='hidden';cal.appendChild(pad);}
  const map={};
  events.forEach(ev=>{
    const d=ev.startP.getDate(),mo=ev.startP.getMonth(),yr=ev.startP.getFullYear();
    if(mo===m&&yr===y)(map[d]=map[d]||[]).push(ev);
  });
  for(let d=1;d<=daysInMonth;d++){
    const cell=document.createElement('div');cell.className='day';
    const num=document.createElement('div');num.className='num';num.textContent=d;cell.appendChild(num);
    if(d===today.getDate())cell.classList.add('today');
    (map[d]||[]).sort((a,b)=>a.startP-b.startP).forEach(ev=>{
      const s=`${fmtTime(ev.startUtc)} – ${fmtTime(ev.endUtc)}`;
      const line=document.createElement('div');line.className='slot';
      const tag=document.createElement('span');tag.className='tag';tag.textContent=`${s} · Busy`;
      line.appendChild(tag);cell.appendChild(line);
    });
    cal.appendChild(cell);
  }
}
(async()=>{
  try{
    await loadSettings();
    await loadEvents();
    renderNext();
    renderCalendar();
    show(0);
  }catch(e){alert(e.message);}
})();
</script>
</body>
</html>
