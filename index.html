<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="color-scheme" content="light only"/>
<title>Pod Display</title>

<style>
:root {
  --bg: #ffffff;
  --text: #333;
  --muted: #777;
  --busy: #2e7d32;
  --shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
}
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  overflow: hidden;
}

/* Core layout */
.frame {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100vw;
  height: 100vh;
  background: white;
  box-sizing: border-box;
  padding: 3vh 3vw; /* white frame effect */
}

/* Slides */
.slide {
  display: none;
  width: 100%;
  height: 100%;
  position: relative;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: var(--shadow);
}
.slide.active {
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fade 1s ease-in-out;
}
@keyframes fade {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Fixed top-right logo */
.logoFixed {
  position: absolute;
  top: 15px;
  right: 20px;
  z-index: 10;
}
.logoFixed img {
  height: 55px;
  width: auto;
  object-fit: contain;
}

/* Hero images */
.hero img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 10px;
}
.heroTitle {
  position: absolute;
  top: 50%;
  width: 100%;
  text-align: center;
  font-size: 48px;
  font-weight: 800;
  color: #444;
  text-shadow: 0 2px 8px rgba(255,255,255,0.6);
}

/* Next Booking */
.card {
  background: white;
  border-radius: 20px;
  padding: 40px 60px;
  box-shadow: var(--shadow);
  text-align: center;
  max-width: 700px;
}
.card h1 {
  font-size: 42px;
  font-weight: 900;
  margin: 0 0 10px;
}
.card h2 {
  font-size: 28px;
  font-weight: 700;
  margin: 10px 0;
}
.card .meta {
  color: var(--muted);
  font-size: 18px;
}
.card .time {
  font-size: 24px;
  font-weight: 700;
  margin: 10px 0;
}
.card .loc {
  font-size: 18px;
}
.card .pill {
  display: inline-block;
  background: var(--busy);
  color: #fff;
  border-radius: 20px;
  padding: 6px 14px;
  font-weight: 700;
  margin-top: 15px;
}

/* Calendar */
.calendarContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 85%;
  height: 85%;
  background: white;
  border-radius: 20px;
  box-shadow: var(--shadow);
  padding: 25px;
  box-sizing: border-box;
}
.calendarHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin-bottom: 10px;
}
.calendarHeader h1 {
  font-size: 36px;
  font-weight: 900;
  margin: 0;
}
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-auto-rows: minmax(70px, 1fr);
  gap: 6px;
  width: 100%;
  flex-grow: 1;
}
.day {
  background: #f8f8f8;
  border-radius: 10px;
  position: relative;
  padding: 6px;
  font-size: 13px;
  overflow: hidden;
}
.day.today {
  outline: 3px solid #0b5fff;
  outline-offset: -3px;
}
.day .num {
  position: absolute;
  top: 4px;
  right: 8px;
  font-weight: 700;
  color: #aaa;
  font-size: 11px;
}
.tag {
  display: inline-block;
  background: var(--busy);
  color: white;
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: 700;
  margin-top: 18px;
}
.footer {
  text-align: center;
  color: #999;
  font-size: 13px;
  padding-top: 8px;
}
</style>
</head>
<body>

<div class="frame">
  <!-- Slides -->
  <div class="slide active" id="slide1">
    <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
    <div class="hero">
      <img id="hero1" alt="Pod Image 1">
      <div class="heroTitle" id="hero1Title"></div>
    </div>
  </div>

  <div class="slide" id="slide2">
    <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
    <div class="card">
      <h1>Next Booking</h1>
      <h2 id="nbWho">—</h2>
      <div class="meta" id="nbOrg">—</div>
      <div class="time" id="nbWhen">—</div>
      <div class="loc" id="nbWhere">—</div>
      <div class="pill">Busy</div>
    </div>
  </div>

  <div class="slide" id="slide3">
    <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
    <div class="hero">
      <img id="hero2" alt="Pod Image 2">
      <div class="heroTitle" id="hero2Title"></div>
    </div>
  </div>

  <div class="slide" id="slide4">
    <div class="calendarContainer">
      <div class="calendarHeader">
        <h1 id="monthLabel">Month YYYY</h1>
        <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <div class="slide" id="slide5">
    <div class="logoFixed"><img src="assets/TraccLogo1.png" alt="TRACC Civil"></div>
    <div class="hero">
      <img id="hero3" alt="Pod Image 3">
      <div class="heroTitle" id="hero3Title"></div>
    </div>
  </div>

  <div class="footer">© Tracc Civil | Pod Display System</div>
</div>

<script>
const TZ = "Australia/Perth";
const qs = id => document.getElementById(id);
const params = new URLSearchParams(location.search);
const podKey = (params.get("pod") || "").replace(/\s+/g, "");
const settingsUrl = "config/settings.json";
let podCfg = null, events = [];
const slides = [
  {id: "slide1", dur: 10000},
  {id: "slide2", dur: 15000},
  {id: "slide3", dur: 15000},
  {id: "slide4", dur: 15000},
  {id: "slide5", dur: 15000},
];
let slideIdx = 0, timer = null;

function showSlide(i) {
  document.querySelectorAll(".slide").forEach(s => s.classList.remove("active"));
  const slide = slides[i];
  qs(slide.id).classList.add("active");
  clearTimeout(timer);
  timer = setTimeout(() => {
    slideIdx = (i + 1) % slides.length;
    showSlide(slideIdx);
  }, slide.dur);
}

function fmtDate(d) {
  return new Intl.DateTimeFormat("en-AU", {
    timeZone: TZ, month: "long", year: "numeric"
  }).format(d);
}
function fmtTime(d) {
  return new Intl.DateTimeFormat("en-AU", {
    timeZone: TZ, hour: "2-digit", minute: "2-digit", hour12: false
  }).format(d);
}

async function loadSettings() {
  const r = await fetch(settingsUrl, {cache: "no-store"});
  const cfg = await r.json();
  podCfg = cfg.pods[podKey];
  const name = podCfg.displayName || podKey;
  ["hero1Title","hero2Title","hero3Title"].forEach(id => qs(id).textContent = name);
  qs("hero1").src = `Pod-Images/${podKey}/01.jpg`;
  qs("hero2").src = `Pod-Images/${podKey}/02.jpg`;
  qs("hero3").src = `Pod-Images/${podKey}/03.jpg`;
}

async function loadEvents() {
  const r = await fetch(podCfg.endpoint, {method: "POST", headers: {"Content-Type": "application/json"}, body: "{}", cache: "no-store"});
  const raw = await r.json();
  events = raw.map(e => ({
    title: e.subject || "",
    organizer: e.organizer || "",
    location: e.location || "",
    start: new Date(e.start),
    end: new Date(e.end)
  }));
}

function renderNextBooking() {
  const now = new Date();
  const next = events.find(e => e.end > now);
  if (!next) return;
  qs("nbWho").textContent = next.title;
  qs("nbOrg").textContent = `Organizer: ${next.organizer}`;
  qs("nbWhen").textContent = `${fmtDate(next.start)} — ${fmtTime(next.start)}–${fmtTime(next.end)}`;
  qs("nbWhere").textContent = `Location: ${next.location}`;
}

function renderCalendar() {
  const cal = qs("calendar");
  cal.innerHTML = "";
  const today = new Date();
  qs("monthLabel").textContent = fmtDate(today);
  const year = today.getFullYear();
  const month = today.getMonth();
  const first = new Date(year, month, 1);
  const firstDay = first.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  for (let i = 0; i < firstDay; i++) {
    const blank = document.createElement("div");
    blank.className = "day";
    blank.style.visibility = "hidden";
    cal.appendChild(blank);
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const dayEl = document.createElement("div");
    dayEl.className = "day";
    const num = document.createElement("div");
    num.className = "num";
    num.textContent = d;
    dayEl.appendChild(num);
    if (d === today.getDate()) dayEl.classList.add("today");
    events.forEach(ev => {
      if (ev.start.getDate() === d && ev.start.getMonth() === month) {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = `${fmtTime(ev.start)} – ${fmtTime(ev.end)} · Busy`;
        dayEl.appendChild(tag);
      }
    });
    cal.appendChild(dayEl);
  }
}

(async()=>{
  await loadSettings();
  await loadEvents();
  renderNextBooking();
  renderCalendar();
  showSlide(0);
})();
</script>
</body>
</html>
